#!/bin/bash
# Entrypoint script - runs as {{ user }} (set by USER directive in Dockerfile)

# Ensure home directory exists
mkdir -p {{ home_dir }}

# Copy bashrc if needed
if [ ! -f {{ home_dir }}/.bashrc ] && [ -f /etc/skel/.bashrc ]; then
    cp /etc/skel/.bashrc {{ home_dir }}/.bashrc
fi

# Create environment file
cat >{{ home_dir }}/.env <<'EOF'
export PATH="{{ home_dir }}/.npm-global/bin:$PATH"
{%- for key, value in environment %}
export {{ key }}={{ value }}
{%- endfor %}
{%- for alias_name, alias_cmd in aliases %}
alias {{ alias_name }}={{ alias_cmd }}
{%- endfor %}
EOF

{%- if git_user_name or git_user_email %}

# Create git config
cat >{{ home_dir }}/.gitconfig <<'EOF'
[user]
{%- if git_user_email %}
    email = {{ git_user_email }}
{%- endif %}
{%- if git_user_name %}
    name = {{ git_user_name }}
{%- endif %}
[alias]
    co = checkout
EOF
{%- endif %}

{%- if history_search %}

# Setup readline history search
cat >{{ home_dir }}/.inputrc <<'EOF'
$include /etc/inputrc
"\e[A":history-search-backward
"\e[B":history-search-forward
EOF
{%- endif %}

# Source it in .bashrc for interactive shells
echo 'source ~/.env' >>{{ home_dir }}/.bashrc

echo "Ready."

# Working directory is already set by docker run -w flag, don't change it

# Source environment and execute command
source {{ home_dir }}/.env
exec -- "$@"
